services:
  dashboard:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: firefetch-dashboard
    restart: unless-stopped
    # Run as root for Docker socket access (alternatively could use group ID)
    user: "0:0"
    ports:
      - "3002:3000"
    volumes:
      # Mount services.json (read-only, accessible to container)
      - /home/ubuntu/ai/infrastructure/services.json:/app/config/services.json:ro
      # Mount Docker socket for container monitoring
      - /var/run/docker.sock:/var/run/docker.sock
      # Persistent volume for SQLite database
      - dashboard-data:/app/data
    environment:
      - NODE_ENV=production
      - NEXT_TELEMETRY_DISABLED=1
      - DB_PATH=/app/data
      - SERVICES_CONFIG_PATH=/app/config/services.json
      - PUSHOVER_USER_KEY=u78a9zhw1zm8cm29mrrsw3otjyh1gg
      - PUSHOVER_APP_KEY=a5igw1desde333xwefcw7is3xv6jxp
      - DOCKER_ENV=true
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - traefik-net
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  traefik-net:
    external: true

volumes:
  dashboard-data:
    driver: local
